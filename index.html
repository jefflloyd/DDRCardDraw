<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DDR A Card Draw</title>
  <style>
    body {
      font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0;
    }

    h1 {
      padding-left: 10px;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    .form {
      flex: 0 0 235px;
      border-bottom: 1px solid #ccc;
    }

    .padded {
      padding: 10px;
    }
	
	.weights {
		margin-left: 2em;
		display: none;
	}
	
	.weights input{
		display: inline-block;
		width: 3em;
		position: relative;
		top: -2em;
		right: 2.3em;
	}
	
	.weights label{
		display: inline-block;
		  padding-top: 2em;
	}
	
	.weights > span{
		display: block;
		padding-bottom: 15px;
		margin-left: -1em;
	}

    .chart-lists {
      flex: 1 0 0;
      overflow: auto;
    }

    .chart-list:not(:first-child) {
      padding-top: 20px;
      opacity: 0.5;
    }

    .chart-list {
      display: flex;
    }

    .chart {
      flex: 1 0 0;
      text-align: center;
      border: 1px solid black;
      border-radius: 5px;
      margin-left: 10px;
      padding: 5px;
    }

    .name, .name-translation {
      font-weight: bold;
    }

    .artist, .artist-translation {
      font-style: italic;
    }

    .chart.beginner {
      background-color: #6eccc4;
    }

    .chart.basic {
      background-color: #e0de5c;
    }

    .chart.difficult {
      background-color: #e8715f;
    }

    .chart.expert {
      background-color: #72cc6e;
    }

    .chart.challenge {
      background-color: #cc71e8;
    }

    .chart.vetoed {
      opacity: 0.3;
    }

    .footer {
      border-top: 1px solid #ccc;
      flex: 0 0 20px;
    }
  </style>
  <script src="ace.js"></script>
</head>
<body>
  <div class='container'>
    <h1>DDR A Card Draw / Randomizer App</h1>
    <div class='form'>
      <div class='padded'>
        Number of charts to randomize:
        <input type='text' class='chart-count' value='5'>
      </div>
      <div class='padded'>
        <span>Lower bound (inclusive):</span>
        <input type='text' id="lower-bound" value='1'>
        <span>Upper bound (inclusive):</span>
        <input type='text' id="upper-bound" value='19'>
      </div>
	  <div class='padded'>
		<label>
		  <input type='checkbox' id='weighted' value='weighted'>Use Weighted Distribution
		</label>
      </div>
	  <div class='padded weights'>
        <label>01<input type='number' id="weight-1" value="1"></label>
        <label>02<input type='number' id="weight-2" value="1"></label>
		<label>03<input type='number' id="weight-3" value="1"></label>
		<label>04<input type='number' id="weight-4" value="1"></label>
		<label>05<input type='number' id="weight-5" value="1"></label>
		<label>06<input type='number' id="weight-6" value="1"></label>
		<label>07<input type='number' id="weight-7" value="1"></label>
		<label>08<input type='number' id="weight-8" value="1"></label>
		<label>09<input type='number' id="weight-9" value="1"></label>
		<label>10<input type='number' id="weight-10" value="1"></label>
		<label>11<input type='number' id="weight-11" value="1"></label>
		<label>12<input type='number' id="weight-12" value="1"></label>
		<label>13<input type='number' id="weight-13" value="1"></label>
		<label>14<input type='number' id="weight-14" value="1"></label>
		<label>15<input type='number' id="weight-15" value="1"></label>
		<label>16<input type='number' id="weight-16" value="1"></label>
		<label>17<input type='number' id="weight-17" value="1"></label>
		<label>18<input type='number' id="weight-18" value="1"></label>
		<label>19<input type='number' id="weight-19" value="1"></label>
      </div>
      <div class='padded'>
        <span>Style:</span>
        <label>
          <input type='radio' name='style' value='single' checked>
          Single
        </label>
        <label>
          <input type='radio' name='style' value='double'>
          Double
        </label>
      </div>
      <div class='padded'>
        <span>Difficulties:</span>
        <label>
          <input type='checkbox' name='difficulty' value='beginner'>Beginner
        </label>
        <label>
          <input type='checkbox' name='difficulty' value='basic'>Basic
        </label>
        <label>
          <input type='checkbox' name='difficulty' value='difficult'>Difficult
        </label>
        <label>
          <input type='checkbox' name='difficulty' value='expert' checked>Expert
        </label>
        <label>
          <input type='checkbox' name='difficulty' value='challenge' checked>Challenge
        </label>
      </div>
      <div class='padded'>
        <span>Include:</span>
        <label>
          <input type='checkbox' name='inclusions' value='extraExclusive'>Extra Exclusive songs
        </label>
        <label>
          <input type='checkbox' name='inclusions' value='unlock'>Unlockable songs
        </label>
        <label>
          <input type='checkbox' name='inclusions' value='usLocked'>Songs unavailable in the US
        </label>
        <label>
          <input type='checkbox' name='inclusions' value='removed'>Removed songs
        </label>
      </div>
      <div class='padded'>
        <button class='random-button'>Randomize!</button>
      </div>
    </div>
    <div class='padded chart-lists'>
    </div>
    <div class='padded footer'>By Jeff Lloyd. I'm aware this looks (as is coded) like crap - better version coming soon. Up to date as of 11/10/2017. <a href="https://github.com/jefflloyd/DDRCardDraw">View on GitHub.</a></div>
  </div>
</body>

</html>

<script type="text/javascript">
  var ready = function(fn) {
    if (document.readyState === 'complete') {
      return fn();
    } else {
      document.addEventListener('DOMContentLoaded', fn, false);
    }
  };

  var createElementHelper = function(tagName, className, innerHTML) {
    var newTag = document.createElement(tagName);
    if (className) {
      newTag.className = className;
    }
    if (innerHTML) {
      newTag.innerHTML = innerHTML;
    }

    return newTag;
  };

  ready(function() {
	var displayWeights = function(event){
	var lowerBound = parseInt(document.querySelector('#lower-bound').value, 10),
        upperBound = parseInt(document.querySelector('#upper-bound').value, 10),
	    weightInputs = document.querySelectorAll(".weights label");
		for (var i = 0, len = weightInputs.length; i < len; i++) {
			var rating = parseInt(weightInputs[i].firstElementChild.id.replace("weight-", ""), 10);
			if (lowerBound <= rating && rating <= upperBound){
				weightInputs[i].style.display = "inline-block";
			}
			else {
				weightInputs[i].style.display = "none";
			}
		}
	};
	document.querySelector('#lower-bound').addEventListener('change', displayWeights);
	document.querySelector('#upper-bound').addEventListener('change', displayWeights);
	document.querySelector('#weighted').addEventListener('change', function(weighted){
		if (weighted.target.checked){
			document.querySelector(".weights").style.display = "block";
		}
		else{
		document.querySelector(".weights").style.display = "none";
		}
	});
    document.querySelector('.random-button').addEventListener('click', function() {
      var chartListLength = document.querySelectorAll('.chart-list').length,
          chartListClass = 'chart-list-' + chartListLength,
          numChartsToRandom = parseInt(document.querySelector('.chart-count').value, 10),
          lowerBound = parseInt(document.querySelector('#lower-bound').value, 10),
          upperBound = parseInt(document.querySelector('#upper-bound').value, 10),
          style = document.querySelector('input[name="style"]:checked').value,
          difficulties = Array.from(document.querySelectorAll('input[name="difficulty"]:checked')).map(function(item) {
            return item.value;
          }),
          inclusions = Array.from(document.querySelectorAll('input[name="inclusions"]:checked')).map(function(item) {
            return item.value;
          }),
          html = createElementHelper('div'),
		  distribution = [], //will be populated with a number of entries for each difficulty rating according to its weight 
		  validCharts = {},
          currentSong,
          charts,
          chart,
          randomIndex,
          randomSong,
          diff;

      html.className = 'chart-list ' + chartListClass;

      for (var i = 0; i < songs.length; i++) {
        currentSong = songs[i];
        charts = currentSong[style];

        if (!(inclusions.indexOf('usLocked') === -1 && currentSong['us_locked']) &&
            !(inclusions.indexOf('extraExclusive') === -1 && currentSong['extra_exclusive']) &&
            !(inclusions.indexOf('removed') === -1 && currentSong['removed']) &&
            !(inclusions.indexOf('unlock') === -1 && currentSong['unlock'])) {
          for (key in charts) {
            chart = charts[key];

            if ((difficulties.indexOf(key) > -1 && chart !== null) &&
                (chart.difficulty >= lowerBound && chart.difficulty <= upperBound)) {
              chartObj = {
                                    'name': currentSong.name,
                                    'nameTranslation': currentSong.name_translation,
                                    'artist': currentSong.artist,
                                    'artistTranslation': currentSong.artist_translation,
                                    'bpm': currentSong.bpm,
                                    'difficulty': key,
                                    'rating': chart.difficulty
                                };
                            if (!validCharts[chart.difficulty]){ //organize charts based on difficulty rating
                                validCharts[chart.difficulty] = [chartObj];
                            }
                            else{
                                validCharts[chart.difficulty].push(chartObj);
                            }
            }
          }
        }
      }
	  
	  for (var i = lowerBound; i <= upperBound; i++){ //for each difficulty rating within bounds
			if (document.querySelector('#weighted').checked){
				weight = document.querySelector('#weight-' + i).value; //Grabs the weight from the corresponding input box
				for (var j = 0; j < weight; j++){ //add entries in the distribution according to its weight
					distribution.push(i);
				}
			}
			else { //No artificial weights. Use the natural weights according to the number of charts in each rating
				var numCharts = validCharts[i].length;
				for (var j = 0; j < numCharts; j++){ //add entries in the distribution according to the number of charts in that rating
					distribution.push(i);
				}
			}
		}

      for (var j = 0; j < numChartsToRandom; j++) {
        randomDifficulty = distribution[Math.floor(Math.random()*distribution.length)]; //determine a random difficulty rating according to the distribution
        selectableCharts = validCharts[randomDifficulty.toString()]; //get the charts from that difficulty rating
		if (selectableCharts.length === 0){ //If there are no more cards to draw from the selected difficulty, draw again
			j--;
			continue;
		}
		randomIndex = Math.floor(Math.random()*selectableCharts.length);
        randomChart = selectableCharts[randomIndex];

        if (randomChart) {
          selectableCharts.splice(randomIndex, 1);
          diff = randomChart.difficulty;

          var chartDiv = createElementHelper('div', 'chart ' + randomChart.difficulty);
          var nameDiv = createElementHelper('div', 'name', randomChart.name);

          if (randomChart.nameTranslation) {
            var nameTranslationDiv = createElementHelper('div', 'name-translation', '[' + randomChart.nameTranslation + ']');
            nameDiv.append(nameTranslationDiv);
          }

          var artistDiv = createElementHelper('div', 'artist', randomChart.artist);

          var bpmDiv = createElementHelper('div', 'bpm', randomChart.bpm + ' BPM');
          var difficultyDiv = createElementHelper('div', 'difficulty ' + diff, diff.toUpperCase() + ' ' + randomChart.rating);

          chartDiv.append(nameDiv);
          chartDiv.append(artistDiv);
          chartDiv.append(bpmDiv);
          chartDiv.append(difficultyDiv);

          html.append(chartDiv);
        }
      }

      document.querySelector('.chart-lists').insertAdjacentElement('afterbegin', html);
      document.querySelectorAll('.' + chartListClass + ' .chart').forEach(function(chartBlock) {
        chartBlock.addEventListener('click', function(e) {
          e.currentTarget.classList.toggle('vetoed');
        });
      });
    });
  });

  window.onbeforeunload = function confirmExit() {
    return "Are you sure you want to leave?";
  };
</script>
